---
title: '<span style="font-size:48pt;">Workflows and Recipes</span>'
subtitle: 'üö£  üç≥ üßë‚Äçüç≥'
author: 'Applied Machine Learning in R<br />Pittsburgh Summer Methodology Series'
date: 'Day 2A &emsp; &emsp; August 9, 2022'
output:
  xaringan::moon_reader:
    css: [../css/xaringan-themer.css, ../css/styles.css]
    nature:
      slideNumberFormat: "%current% / %total%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: false
    self_contained: true
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=9, fig.height=3.5, fig.retina=3,
  fig.showtext = TRUE,
  out.width = "100%",
  cache = FALSE,
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE,
  collapse = TRUE
)
```

```{r xaringanExtra, echo=FALSE}
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
```

```{r packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(countdown)
library(patchwork)
library(xaringanthemer)
```

class: inverse, center, middle
# Workflows

---

# Setup

.scroll[
```{r, eval=FALSE}
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- read_csv("https://rb.gy/hm7p84")

# Create train/test split, stratified by fare
set.seed(2022)
fare_split <- initial_split(data = titanic, prop = 0.8, strata = 'fare')

fare_train <- training(fare_split)
fare_test <- testing(fare_split)

# Set up model (linear regression using lm)
lm_model <- 
  linear_reg() %>% 
  set_mode("regression") %>% 
  set_engine("lm")
```
]

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- read_csv("../data/titanic.csv")

# Create initial split, stratified by fare
set.seed(2022)
fare_split <- initial_split(data = titanic, prop = 0.8, strata = 'fare')
fare_train <- training(fare_split)
fare_test <- testing(fare_split)

# Set up model
lm_model <- 
  linear_reg() %>% 
  set_mode("regression") %>% 
  set_engine("lm")
```

---

## Create a simple workflow

.onecol[
-   A .imp[workflow] collects various specifications for your ML experiment

  -   The **model** specifies the algorithm, mode, engine, and tuning steps
  
  -   The **preprocessor** specifies the formula and feature engineering steps
]

```{r}
fare_wflow <-
  workflow() %>% 
  add_model(lm_model) %>% 
  print()
```

---

## Add a formula as a simple preprocessor

.onecol[
-   We can use a .imp[formula] as a simple preprocessor (without feature engineering)
]

```{r}
fare_wflow <- 
  fare_wflow %>% 
  add_formula(fare ~ pclass + sex + age + sibsp + parch) %>% 
  print()
```

.footnote[*Note.* We will soon learn to use "recipes" as more powerful preprocessors]

---

## Fit a model using a workflow

.onecol[
-   We can explicitly fit the model to the training data using `fit()`
]

.scroll.h-1l[
```{r}
fare_fit <- 
  fit(fare_wflow, fare_train) %>% 
  print()
```
]

---

## Make predictions using the fit model

.onecol[
-   We can explicitly make predictions in the testing set using `predict()`
]

.scroll.h-1l[
```{r, message=FALSE}
fare_pred <- 
  predict(fare_fit, fare_test) %>% 
  print()
```
]

---

## A helpful shortcut

.onecol[
-   Or we can do both automatically using `last_fit()` and the "split" object

  -   This will fit to the (entire) training set and predict the testing set
]

.scroll.h-2l[
```{r}
fare_fit <- last_fit(fare_wflow, split = fare_split)
fare_fit
```
]

---

## Collecting the predictions

.onecol[
-   We can gather the testing set predictions with `collect_predictions()`
]

.scroll.h-1l[
```{r}
fare_pred <- collect_predictions(fare_fit)
fare_pred
```

]

.footnote[*Note.* We will soon learn how to plot these predictions against the true values.]

---

## Collecting the performance metrics

.onecol[
-   We can gather the testing set predictions with `collect_metrics()`
]

.scroll.h-1l[
```{r}
fare_perf <- collect_metrics(fare_fit)
fare_perf
```

]

.footnote[*Note.* We will soon learn how to interpret these metrics and calculate alternatives.]

---

## Putting it all together

.scroll.h-0l[
```{r, eval=FALSE}
# Load packages and data
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- read_csv("https://rb.gy/hm7p84")

# Create data splits, stratified by fare
set.seed(2022)
fare_split <- initial_split(data = titanic, prop = 0.8, strata = 'fare')

# Set up model (linear regression using lm)
lm_model <- 
  linear_reg() %>% 
  set_mode("regression") %>% 
  set_engine("lm")

# Set up workflow with simple formula preprocessor
fare_wflow <-
  workflow() %>% 
  add_model(lm_model) %>% 
  add_formula(fare ~ pclass + sex + age + sibsp + parch)

# Fit workflow and make predictions using data splits
fare_fit <- last_fit(fare_wflow, split = fare_split)

# Collect predictions and performance metrics
fare_pred <- collect_predictions(fare_fit)
fare_perf <- collect_metrics(fare_fit)
```
]

---

class: inverse, center, middle
# Recipes

---
class: inverse, center, middle
# Time for a Break!
```{r countdown, echo=FALSE}
countdown(
  minutes = 10, 
  seconds = 0, 
  right = "33%", 
  left = "33%",
  bottom = "15%",
  color_background = "white",
  color_text = "black",
  color_running_background = "white",
  color_running_text = "black",
  warn_when = 120
)
```
