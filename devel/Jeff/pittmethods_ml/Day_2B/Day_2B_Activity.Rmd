---
title: "Day 2B Activity (Basic Predictive Modeling)"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    df_print: paged
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  df_print = "paged"
)
```

# Load packages

```{r, message=FALSE}
library(tidyverse)
library(caret)
library(recipes)
```

---

# Predicting Titanic survival (with GLM)

```{r}
# Read in data
titanic <- read_csv("titanic.csv")

# Create a training and testing set (stratified by survived)
set.seed(2021)
surv_index <- createDataPartition(titanic$survived, p = 0.75, list = FALSE)
surv_train <- titanic[surv_index, ]
surv_test <- titanic[-surv_index, ]
```

```{r}
# Create a preprocessing recipe (no prep)
surv_recipe <- 
  titanic %>% 
  recipe(survived ~ .) %>% 
  step_normalize(all_numeric_predictors()) %>% 
  step_dummy(all_nominal_predictors()) %>% 
  step_interact(~sex_male:starts_with("pclass")) %>% 
  step_nzv(all_predictors()) %>% 
  step_corr(all_predictors())
```

```{r}
set.seed(2021)
#  Train the model using the recipe, data, and method
surv_tc <- trainControl(method = "cv", number = 10)

surv_glm <- train(
  surv_recipe, 
  data = surv_train,
  method = "glm",
  trControl = surv_tc
)
surv_glm$results
```

```{r}
# Extract model predictions as classes
surv_pred <- predict(surv_glm, newdata = surv_test)
glimpse(surv_pred)
```

```{r}
# Extract model predictions as probabilities
surv_prob <- predict(surv_glm, newdata = surv_test, type = "prob")
glimpse(surv_prob)
```


```{r}
# Bake test set and then calculate performance
surv_test_baked <- 
  surv_recipe %>% 
  prep(training = surv_train) %>% 
  bake(new_data = surv_test)
postResample(pred = surv_pred, obs = surv_test_baked$survived)
```

```{r}
test_data <- bind_cols(
  surv_prob, 
  obs = surv_test_baked$survived, 
  pred = surv_pred
)

cm <- yardstick::conf_mat(test_data, truth = obs, estimate = pred)
autoplot(cm, type = "heatmap")
summary(cm)

yardstick::mcc(test_data, truth = obs, estimate = pred)
```

```{r}
roc <- yardstick::roc_curve(test_data, yes, truth = obs, event_level = "second")
autoplot(roc)
yardstick::roc_auc(test_data, yes, truth = obs, event_level = "second")
```


```{r}
surv_vi <- varImp(surv_glm, scale = FALSE)
surv_vi
plot(surv_vi)
```

```{r}
# Look at the model coefficients (not available for every algorithm)
surv_glm$finalModel
```

---

## Hands-on Activity

TBD