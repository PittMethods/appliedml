---
title: '<span style="font-size:48pt;">Workflows and Metrics</span>'
subtitle: 'üö£  üíØ  üìè '
author: 'Applied Machine Learning in R<br />Pittsburgh Summer Methodology Series'
date: 'Day 2A &emsp; &emsp; August 9, 2022'
output:
  xaringan::moon_reader:
    css: [../css/xaringan-themer.css, ../css/styles.css]
    nature:
      slideNumberFormat: "%current% / %total%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: false
    self_contained: true
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=9, fig.height=3.5, fig.retina=3,
  fig.showtext = TRUE,
  out.width = "100%",
  cache = FALSE,
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE,
  collapse = TRUE
)
```

```{r xaringanExtra, echo=FALSE}
xaringanExtra::use_tachyons()
xaringanExtra::use_clipboard()
```

```{r packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(countdown)
library(patchwork)
library(xaringanthemer)
```

class: inverse, center, middle
# Workflows

---

# Setup

.scroll[
```{r, eval=FALSE}
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- 
  read_csv("https://tinyurl.com/titanic-pm") %>% 
  mutate(
    survived = factor(survived),
    pclass = factor(pclass),
    sex = factor(sex)
  )

# Create train/test split, stratified by fare
set.seed(2022)
fare_split <- initial_split(data = titanic, prop = 0.8, strata = 'fare')

fare_train <- training(fare_split)
fare_test <- testing(fare_split)

# Set up model (linear regression using lm)
lm_model <- 
  linear_reg() %>% 
  set_mode("regression") %>% 
  set_engine("lm")
```
]

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- 
  read_csv("../data/titanic.csv") %>% 
  mutate(
    survived = factor(survived),
    pclass = factor(pclass),
    sex = factor(sex)
  )

# Create initial split, stratified by fare
set.seed(2022)
fare_split <- initial_split(data = titanic, prop = 0.8, strata = 'fare')
fare_train <- training(fare_split)
fare_test <- testing(fare_split)

# Set up model
lm_model <- 
  linear_reg() %>% 
  set_mode("regression") %>% 
  set_engine("lm")
```

---

## Create a simple workflow

.onecol[
-   A .imp[workflow] collects various specifications for your ML experiment

  -   The **model** specifies the algorithm, mode, engine, and tuning steps
  
  -   The **preprocessor** specifies the formula and feature engineering steps
]

```{r}
fare_wflow <-
  workflow() %>% 
  add_model(lm_model) %>% 
  print()
```

---

## Add a formula as a simple preprocessor

.onecol[
-   We can use a .imp[formula] as a simple preprocessor (without feature engineering)
]

```{r}
fare_wflow <- 
  fare_wflow %>% 
  add_formula(fare ~ pclass + sex + age + sibsp + parch) %>% 
  print()
```

.footnote[*Note.* We will soon learn to use "recipes" as more powerful preprocessors]

---

## Fit a model using a workflow

.onecol[
-   We can explicitly fit the model to the training data using `fit()`
]

.scroll.h-1l[
```{r}
fare_fit <- 
  fit(fare_wflow, fare_train) %>% 
  print()
```
]

---

## Make predictions using the fit model

.onecol[
-   We can explicitly make predictions in the testing set using `predict()`
]

.scroll.h-1l[
```{r, message=FALSE}
fare_pred <- 
  predict(fare_fit, fare_test) %>% 
  print()
```
]

---

## A helpful shortcut

.onecol[
-   Or we can do both automatically using `last_fit()` and the "split" object

  -   This will fit to the (entire) training set and predict the testing set
]

.scroll.h-2l[
```{r}
fare_fit <- last_fit(fare_wflow, split = fare_split)
fare_fit
```
]

---

## Collecting the predictions

.onecol[
-   We can gather the testing set predictions with `collect_predictions()`
]

.scroll.h-1l[
```{r}
fare_pred <- collect_predictions(fare_fit)
fare_pred
```

]

---

## Plotting the predictions (basic)

.pull-left[
```{r, eval=FALSE}
ggplot(
  fare_pred, 
  aes(x = fare, y = .pred)
) + 
  geom_point()
```

```{r, echo=FALSE, fig.show="hide"}
ggplot(fare_pred, aes(x = fare, y = .pred)) + 
  geom_point() +
  theme_xaringan(css_file = "../css/xaringan-themer.css") +
  theme(
    panel.grid.minor = element_blank(), 
    panel.background = element_rect(fill = "white")
  )
ggsave("../figs/fare_pred1.png", width = 3.5, height = 3.5, units = "in")
```

]

.pull-right[
![](../figs/fare_pred1.png)
]

---

## Plotting the predictions (advanced)

.pull-left[
```{r, eval=FALSE}
ggplot(
  fare_pred, 
  aes(x = fare, y = .pred)
) + 
  geom_point(alpha = .2) +
  geom_abline(color = "darkred") +
  coord_obs_pred() +
  labs(
    x = "Observed Fare", 
    y = "Predicted Fare"
  )
```

```{r, echo=FALSE, fig.show="hide"}
ggplot(
  fare_pred, 
  aes(x = fare, y = .pred)
) + 
  geom_point(alpha = .2) +
  geom_abline(color = "darkred") +
  coord_obs_pred() +
  labs(
    x = "Observed Fare", 
    y = "Predicted Fare"
  ) +
  theme_xaringan(css_file = "../css/xaringan-themer.css") +
  theme(
    panel.grid.minor = element_blank(), 
    panel.background = element_rect(fill = "white")
  )
ggsave("../figs/fare_pred2.png", width = 3.5, height = 3.5, units = "in")
```

]

.pull-right[
![](../figs/fare_pred2.png)
]

---

## Collecting the performance metrics

.onecol[
-   We can gather the testing set predictions with `collect_metrics()`
]

```{r}
fare_perf <- collect_metrics(fare_fit)
fare_perf
```

.footnote[*Note.* We will soon learn how to interpret these metrics and calculate alternatives.]

---

## Putting it all together

.scroll.h-0l[
```{r, eval=FALSE}
# Load packages and data
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- 
  read_csv("https://tinyurl.com/titanic-pm") %>% 
  mutate(
    survived = factor(survived),
    pclass = factor(pclass),
    sex = factor(sex)
  )

# Create data splits, stratified by fare
set.seed(2022)
fare_split <- initial_split(data = titanic, prop = 0.8, strata = 'fare')

# Set up model (linear regression using lm)
lm_model <- 
  linear_reg() %>% 
  set_mode("regression") %>% 
  set_engine("lm")

# Set up workflow with simple formula preprocessor
fare_wflow <-
  workflow() %>% 
  add_model(lm_model) %>% 
  add_formula(fare ~ pclass + sex + age + sibsp + parch)

# Fit workflow and make predictions using data splits
fare_fit <- last_fit(fare_wflow, split = fare_split)

# Collect predictions and performance metrics
fare_pred <- collect_predictions(fare_fit)
fare_perf <- collect_metrics(fare_fit)
```
]

---

## Modifying it for classification

.scroll.h-0l[
```{r, eval=FALSE}
# Load packages and data
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
titanic <- 
  read_csv("https://tinyurl.com/titanic-pm") %>% 
  mutate(
    survived = factor(survived),
    pclass = factor(pclass),
    sex = factor(sex)
  )

# Create data splits, stratified by survived
set.seed(2022)
surv_split <- initial_split(titanic, prop = 0.8, strata = 'survived') #<<

# Set up model (logistic regression using glm)
glm_model <- 
  logistic_reg() %>% #<<
  set_mode("classification") %>% #<<
  set_engine("glm") #<<

# Set up workflow with simple formula preprocessor
surv_wflow <-
  workflow() %>% 
  add_model(glm_model) %>% #<<
  add_formula(survived ~ pclass + sex + age + sibsp + parch + fare) #<<

# Fit workflow and make predictions using data splits
surv_fit <- last_fit(surv_wflow, split = surv_split)

# Collect predictions and performance metrics
surv_pred <- collect_predictions(surv_fit)
surv_perf <- collect_metrics(surv_fit)
```

```{r, echo=FALSE}
# Create data splits, stratified by survived
set.seed(2022)
surv_split <- initial_split(titanic, prop = 0.8, strata = 'survived') #<<

# Set up model (logistic regression using glm)
glm_model <- #<<
  logistic_reg() %>% #<<
  set_mode("classification") %>% #<<
  set_engine("glm") #<<

# Set up workflow with simple formula preprocessor
surv_wflow <-
  workflow() %>% 
  add_model(glm_model) %>% #<<
  add_formula(survived ~ pclass + sex + age + sibsp + parch + fare) #<<

# Fit workflow and make predictions using data splits
surv_fit <- last_fit(surv_wflow, split = surv_split)

# Collect predictions and performance metrics
surv_pred <- collect_predictions(surv_fit)
surv_perf <- collect_metrics(surv_fit)
```
]

---

## Inspecting Classification Results

.scroll.h-0l[
```{r}
surv_pred
```
]

---

## Inspecting Classification Results

```{r}
surv_perf
```

---
class: inverse, center, middle
# Time for a Break!
```{r countdown, echo=FALSE}
countdown(
  minutes = 10, 
  seconds = 0, 
  right = "33%", 
  left = "33%",
  bottom = "15%",
  color_background = "white",
  color_text = "black",
  color_running_background = "white",
  color_running_text = "black",
  warn_when = 120
)
```
